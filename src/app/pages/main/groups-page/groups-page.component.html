<div class="main">
  <div class="side-block">
    <div style="display: flex;justify-content: space-between; align-items: center;margin-bottom: 10px;">
      <button *ngIf="sideBlockStatus === 1" nz-button [nzType]="'primary'" (click)="openAddGroup()">å»ºå›¢</button>
      <button *ngIf="sideBlockStatus === 2" nz-button (click)="cancelAddGroup()">å–æ¶ˆ</button>
      <button *ngIf="sideBlockStatus === 3" nz-button (click)="exitGroup()">è¿”å›</button>

      <button *ngIf="sideBlockStatus === 2" nz-button
              [nzType]="'primary'"
              [nzLoading]="waitingResp"
              (click)="addGroup()">ä¿å­˜
      </button>

      <nz-button-group *ngIf="sideBlockStatus === 3 && isGroupOnwer(groupId) && isGroupActive(groupId)">
        <button nz-button (click)="changeGroupStatus(false)"
                [nzLoading]="waitingResp">
          <span>å®Œæˆ</span>
        </button>
        <button nz-button [nzType]="'danger'" (click)="changeGroupStatus(true)"
                [nzLoading]="waitingResp">
          <span>å–æ¶ˆ</span>
        </button>
      </nz-button-group>

      <div *ngIf="sideBlockStatus === 1" style="float: right;">
        <nz-checkable-tag [nzChecked]="groupType === 1" (nzChange)="switchGroups($event, 1)">
          å¾é›†ä¸­
        </nz-checkable-tag>
        <nz-checkable-tag [nzChecked]="groupType === 2" (nzChange)="switchGroups($event, 2)">
          æˆ‘å‘èµ·çš„
        </nz-checkable-tag>
        <nz-checkable-tag [nzChecked]="groupType === 3" (nzChange)="switchGroups($event, 3)">
          æˆ‘å‚ä¸çš„
        </nz-checkable-tag>
      </div>
    </div>

    <!-- æ·»åŠ è®¢å•å›¢ -->
    <div *ngIf="sideBlockStatus === 2">
      <form nz-form [formGroup]="groupAddForm" (ngSubmit)="addGroup()">
        <div nz-form-item>
          <div nz-form-control [nzValidateStatus]="groupAddForm.get('groupName')">
            <nz-input formControlName="groupName" [nzPlaceHolder]="'å›¢ç»„åç§°'" [nzSize]="'large'">
            </nz-input>
          </div>
        </div>
        <div nz-form-item>
          <div nz-form-control [nzValidateStatus]="groupAddForm.get('dueTime')">
            <nz-timepicker [nzSize]="'large'" formControlName="dueTime" [nzFormat]="'HH:mm'"></nz-timepicker>
          </div>
        </div>
      </form>
    </div>

    <!-- è®¢å•å›¢åˆ—è¡¨ -->
    <div *ngIf="sideBlockStatus !== 2">
      <div class="groups-title">
        {{sideBlockStatus === 1 ? 'è®¢å•å›¢åˆ—è¡¨' : 'è®¢å•å›¢'}}
      </div>
      <nz-spin *ngIf="groupLoading" [nzTip]="'æ­£åœ¨è¯»å–æ•°æ®...'" style="text-align: center;"></nz-spin>
      <div *ngIf="!groupLoading && groups.length === 0" class="groups-none">
        ä¸å­˜åœ¨çš„
      </div>
      <ng-template ngFor let-group [ngForOf]="groups">
        <div class="group-item"
             [class.item-hover]="sideBlockStatus === 1"
             [class.item-selected]="group.id === groupId"
             *ngIf="sideBlockStatus === 1 || group.id === groupId"
             (click)="selectGroup(group.id)">
          <div class="group-item-info">
            <div class="group-item-info-line">
              <nz-avatar nzSize="small" nzIcon="user" [nzSrc]="group.composer?.avatar_url || ''"></nz-avatar>
              <span style="margin-left: 10px;flex: 1;">{{group.composer?.username}}</span>
              <span class="price">ï¿¥{{group.totalPrice}}</span>
            </div>
            <div class="group-item-info-line">
              <span class="group-item-name">{{group.name}}</span>
            </div>
            <div class="group-item-info-line">
              <nz-tag [nzColor]="'green'" *ngIf="group.status === 1">å¾é›†ä¸­</nz-tag>
              <nz-tag [nzColor]="'red'" *ngIf="group.status === 3">å·²å–æ¶ˆ</nz-tag>
              <nz-tag [nzColor]="'blue'" *ngIf="group.status === 2">å·²å®Œæˆ</nz-tag>
              <span>{{formatRemainTime(group.remainTime)}}</span>
            </div>
          </div>
          <div class="group-item-arrow" *ngIf="sideBlockStatus === 1">
            <i class="anticon anticon-right"></i>
          </div>
        </div>
      </ng-template>
    </div>

    <!-- è®¢å•åˆ—è¡¨ -->
    <div *ngIf="sideBlockStatus === 3">
      <div class="orders-title">
        è®¢å•åˆ—è¡¨
      </div>
      <div *ngIf="orders.length === 0" class="orders-none">
        ä¸å­˜åœ¨çš„
      </div>
      <ng-template ngFor let-order [ngForOf]="orders">
        <div class="order-item">
          <div class="order-item-user-line">
            <nz-avatar nzSize="small" nzIcon="user" [nzSrc]="order.user?.avatar_url || ''"></nz-avatar>
            <span class="order-username">{{order.user.username || order.user.nickname}}</span>
            <span class="price">ï¿¥{{order.totalPrice}}</span>
          </div>
          <ng-template ngFor let-row [ngForOf]="order.rows">
            <div class="order-item-line">
              <div class="order-remove">
                <a *ngIf="isGroupActive(groupId) && order.user.id === store.user?.id" (click)="removeOrder(row.id)">
                  <i class="anticon anticon-close"></i>
                </a>
              </div>
              <span class="order-name">{{row.product_name}}</span>
              <span class="order-quantity">{{row.quantity}}</span>
            </div>
            <div *ngIf="row.remark" class="order-remark">
              <span>{{row.remark}}</span>
            </div>
          </ng-template>
        </div>
      </ng-template>
    </div>
  </div>

  <div class="product-block">
    <nz-tabset>
      <nz-tab>
        <ng-template #nzTabHeading>
          è¡¨æ ¼å¼èœå•
        </ng-template>
        <nz-table #nzTable [nzDataSource]="products" [nzIsPagination]="false"
                  nzSize="small" [nzShowTotal]="true"
                  [nzLoading]="tableLoading">
          <thead nz-thead>
          <tr>
            <th nz-th nzWidth="40%"><span>èœå•å</span></th>
            <th nz-th nzWidth="20%">
              <span>ç±»åˆ«</span>
              <nz-dropdown>
                <i class="anticon anticon-filter" nz-dropdown
                   [style.color]="condition.category ? 'red' : ''"></i>
                <ul nz-menu>
                  <li nz-menu-item *ngFor="let option of categoryOptions"
                      (click)="condition.category = option;listTodayProduct('reload')">
                    <span>{{option}}</span>
                  </li>
                </ul>
                <div nz-table-filter>
                  <span nz-table-filter-clear (click)="condition.category = '';listTodayProduct('reload')">é‡ç½®</span>
                </div>
              </nz-dropdown>
            </th>
            <th nz-th nzWidth="20%"><span>ä»·æ ¼</span></th>
            <th nz-th nzWidth="20%" *ngIf="groupId && (isGroupOnwer(groupId) || !isGroupExpired(groupId))">
              <span>æ“ä½œ</span>
            </th>
          </tr>
          </thead>
          <tbody nz-tbody>
          <tr nz-tbody-tr *ngFor="let data of nzTable.data; let i = index;"
              [class.invalid-product]="!data.valid">
            <td nz-td nzWidth="40%">
              {{data.name}}
              <span *ngIf="data.spicy">ğŸŒ¶</span>
            </td>
            <td nz-td nzWidth="20%">{{data.category}}</td>
            <td nz-td nzWidth="20%">{{data.price}}</td>
            <td nz-td nzWidth="20%" *ngIf="groupId && (isGroupOnwer(groupId) || !isGroupExpired(groupId))">
              <a (click)="openOrderConfirm(data)">ç‚¹é¤</a>
            </td>
          </tr>
          </tbody>
        </nz-table>
      </nz-tab>
      <nz-tab>
        <ng-template #nzTabHeading>
          å†…å®¹å¼èœå•
        </ng-template>
        æ•¬è¯·æœŸå¾…ï¼
      </nz-tab>
    </nz-tabset>
  </div>
</div>

<ng-template #order_dialog>
  <form nz-form [formGroup]="orderAddForm" (submit)="addOrder()">
    <div nz-row style="margin-bottom: 10px;">
      <div nz-col [nzSpan]="12">
        <label>ä½ é€‰æ‹©äº†</label>
        <span style="color: blue;font-size: 15px;margin-left: 5px;">{{selectedProduct.name}}</span>
      </div>
      <div nz-col [nzSpan]="12" style="text-align: right;">
        <span>æ•°é‡ï¼š</span>
        <nz-input-number [nzMin]="1" formControlName="quantity"></nz-input-number>
      </div>
    </div>
    <div *ngIf="selectedProduct.product_options.length > 0" nz-row>
      <label>å¯é€‰é¡¹ï¼š</label>
      <nz-radio-group formControlName="remark">
        <label *ngFor="let option of selectedProduct.product_options" nz-radio [nzValue]="option.option_name">
          <span>{{option.option_name}}</span>
        </label>
      </nz-radio-group>
    </div>
  </form>
</ng-template>
