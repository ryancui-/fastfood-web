<div class="main">
  <div class="side-block">
    <div style="display: flex;justify-content: space-between; align-items: center;margin-bottom: 10px;">
      <button *ngIf="sideBlockStatus === 1" nz-button [nzType]="'primary'" (click)="openAddGroup()">建团</button>
      <button *ngIf="sideBlockStatus === 2" nz-button (click)="cancelAddGroup()">取消</button>
      <button *ngIf="sideBlockStatus === 3" nz-button (click)="exitGroup()">返回</button>

      <button *ngIf="sideBlockStatus === 2" nz-button
              [nzType]="'primary'"
              [nzLoading]="waitingResp"
              (click)="addGroup()">保存
      </button>

      <nz-button-group
        *ngIf="sideBlockStatus === 3 && isGroupOnwer(selectedGroup.id) && isGroupActive(selectedGroup.id)">
        <button nz-button (click)="changeGroupStatus(false)"
                [nzLoading]="waitingResp">
          <span>完成</span>
        </button>
        <button nz-button [nzType]="'danger'" (click)="changeGroupStatus(true)"
                [nzLoading]="waitingResp">
          <span>取消</span>
        </button>
      </nz-button-group>

      <div *ngIf="sideBlockStatus === 1" style="float: right;">
        <nz-checkable-tag [nzChecked]="groupType === 1" (nzChange)="switchGroups($event, 1)">
          征集中
        </nz-checkable-tag>
        <nz-checkable-tag [nzChecked]="groupType === 2" (nzChange)="switchGroups($event, 2)">
          我发起的
        </nz-checkable-tag>
        <nz-checkable-tag [nzChecked]="groupType === 3" (nzChange)="switchGroups($event, 3)">
          我参与的
        </nz-checkable-tag>
      </div>
    </div>

    <!-- 添加订单团 -->
    <div *ngIf="sideBlockStatus === 2">
      <form nz-form [formGroup]="groupAddForm" (ngSubmit)="addGroup()">
        <div nz-form-item>
          <div nz-form-control [nzValidateStatus]="groupAddForm.get('groupName')">
            <nz-input formControlName="groupName" [nzPlaceHolder]="'团组名称'" [nzSize]="'large'">
            </nz-input>
          </div>
        </div>
        <div nz-form-item>
          <div nz-form-control [nzValidateStatus]="groupAddForm.get('dueTime')">
            <nz-timepicker [nzSize]="'large'" formControlName="dueTime" [nzFormat]="'HH:mm'"></nz-timepicker>
          </div>
        </div>
      </form>
    </div>

    <!-- 订单团列表 -->
    <div *ngIf="sideBlockStatus !== 2">
      <div class="groups-title">
        {{sideBlockStatus === 1 ? '订单团列表' : '订单团'}}
      </div>
      <nz-spin *ngIf="groupLoading" [nzTip]="'正在读取数据...'" style="text-align: center;"></nz-spin>
      <div *ngIf="!groupLoading && groups.length === 0" class="groups-none">
        不存在的
      </div>
      <ng-template ngFor let-group [ngForOf]="groups">
        <div class="group-item"
             [class.item-hover]="sideBlockStatus === 1"
             [class.item-selected]="group.id === selectedGroup.id"
             *ngIf="sideBlockStatus === 1 || group.id === selectedGroup.id"
             (click)="selectGroup(group.id)">
          <div class="group-item-info">
            <div class="group-item-info-line">
              <nz-avatar nzSize="small" nzIcon="user" [nzSrc]="group.composer?.avatar_url || ''"></nz-avatar>
              <span style="margin-left: 10px;flex: 1;">{{group.composer?.username}}</span>
              <span *ngIf="selectedGroup.id" class="price">￥{{selectedGroup.totalPrice}}</span>
            </div>
            <div class="group-item-info-line">
              <span class="group-item-name">{{group.name}}</span>
            </div>
            <div class="group-item-info-line">
              <nz-tag [nzColor]="'green'" *ngIf="group.status === 1">征集中</nz-tag>
              <nz-tag [nzColor]="'red'" *ngIf="group.status === 3">已取消</nz-tag>
              <nz-tag [nzColor]="'blue'" *ngIf="group.status === 2">已完成</nz-tag>
              <span>{{formatRemainTime(group.remainTime)}}</span>
            </div>
          </div>
          <div class="group-item-arrow" *ngIf="sideBlockStatus === 1">
            <i class="anticon anticon-right"></i>
          </div>
        </div>
      </ng-template>
    </div>

    <!-- 订单列表 -->
    <div *ngIf="sideBlockStatus === 3">
      <div class="orders-title">
        订单列表
      </div>
      <nz-spin *ngIf="orderLoading" [nzTip]="'正在读取数据...'" style="text-align: center;"></nz-spin>
      <div *ngIf="orders.length === 0" class="orders-none">
        不存在的
      </div>
      <ng-template ngFor let-order [ngForOf]="orders">
        <div class="order-item">
          <div class="order-item-user-line">
            <nz-avatar nzSize="small" nzIcon="user" [nzSrc]="order.user?.avatar_url || ''"></nz-avatar>
            <span class="order-username">{{order.user.username || order.user.nickname}}</span>
            <span class="price">￥{{order.totalPrice}}</span>
          </div>
          <ng-template ngFor let-row [ngForOf]="order.rows">
            <div class="order-item-line">
              <div class="order-remove">
                <a *ngIf="isGroupActive(selectedGroup.id) && order.user.id === store.user?.id"
                   (click)="removeOrder(row.id)">
                  <i class="anticon anticon-close"></i>
                </a>
              </div>
              <span class="order-name">{{row.product_name}}</span>
              <span class="order-quantity">{{row.quantity}}</span>
            </div>
            <div *ngIf="row.remark" class="order-remark">
              <span>{{row.remark}}</span>
            </div>
          </ng-template>
        </div>
      </ng-template>
    </div>
  </div>

  <div class="product-block">
    <nz-spin *ngIf="products.length === 0" [nzTip]="'正在读取今日菜单...'" style="text-align: center;"></nz-spin>
    <card-menu *ngIf="products.length !== 0"
               [data]="products" (productSelect)="openOrderConfirm($event)"></card-menu>
  </div>
</div>

<ng-template #order_dialog>
  <form nz-form [formGroup]="orderAddForm" (submit)="addOrder()">
    <div nz-row style="margin-bottom: 10px;">
      <div nz-col [nzSpan]="12">
        <label>你选择了</label>
        <span style="color: blue;font-size: 15px;margin-left: 5px;">{{selectedProduct.name}}</span>
      </div>
      <div nz-col [nzSpan]="12" style="text-align: right;">
        <span>数量：</span>
        <nz-input-number [nzMin]="1" formControlName="quantity"></nz-input-number>
      </div>
    </div>
    <div *ngIf="selectedProduct.product_options.length > 0" nz-row>
      <label>可选项：</label>
      <nz-radio-group formControlName="remark">
        <label *ngFor="let option of selectedProduct.product_options" nz-radio [nzValue]="option.option_name">
          <span>{{option.option_name}}</span>
        </label>
      </nz-radio-group>
    </div>
  </form>
</ng-template>
